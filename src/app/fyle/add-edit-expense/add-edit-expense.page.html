<ion-header [ngClass]="{'d-none': isCameraPreviewStarted}" mode="md">
  <ion-toolbar class="add-edit-expense--toolbar" [ngClass]="{'add-edit-expense--toolbar__review': reviewList?.length}">
    <ion-buttons *ngIf="navigateBack" mode="md" slot="start">
      <ion-button (click)="showClosePopup()">
        <ion-icon [src]="'../../../../assets/svg/arrow-left.svg'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons *ngIf="!navigateBack" mode="md" slot="start">
      <ion-button (click)="showClosePopup()">
        <ion-icon class="fy-icon-close" [src]="'../../../../assets/svg/fy-close.svg'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title
      *ngIf="mode"
      class="page-title"
      mode="md"
      [ngClass]="{'add-edit-expense--title__review': reviewList?.length}"
    >
      <div *ngIf="mode === 'add'" class="add-edit-expense--toolbar__title">Add Expense</div>
      <div *ngIf="mode === 'edit'">
        <ng-container *ngIf="reviewList?.length;else editMode">
          Review Expense
          <div class="add-edit-expense--sub-header">
            {{ +activeIndex + 1 }} of {{ reviewList?.length }} expense{{reviewList?.length > 1 ? 's' : ''}}
          </div>
        </ng-container>
        <ng-template #editMode>
          <div>{{isIncompleteExpense ? 'Review' : 'Edit'}} Expense</div>
        </ng-template>
      </div>
    </ion-title>

    <ion-buttons class="add-edit-expense--header-btn-container" slot="end">
      <ion-button
        *ngIf="reviewList?.length || mode === 'edit'"
        class="add-edit-expense--header-btn-container__btn"
        (click)="openCommentsModal()"
      >
        <ion-icon [src]="'../../../assets/svg/fy-chat-2.svg'" slot="icon-only"></ion-icon>
      </ion-button>
      <ng-container *ngIf="(reviewList?.length || mode === 'edit') && !isCccExpense && etxn$|async as etxn">
        <ng-container *ngIf="canRemoveFromReport || (!isRedirectedFromReport && !etxn.tx.report_id)">
          <ion-button class="add-edit-expense--header-btn-container__btn" (click)="deleteExpense(etxn.tx.report_id)">
            <ion-icon [src]="'../../../assets/svg/fy-delete.svg'" slot="icon-only"></ion-icon>
          </ion-button>
        </ng-container>
      </ng-container>
      <ng-container *ngIf="etxn$|async as etxn">
        <ng-container *ngIf="isConnected$|async as isConnected">
          <ng-container *ngIf="!(etxn?.tx?.report_id) && !(reviewList?.length > 1)">
            <ng-container *ngIf="actionSheetOptions$|async as actionSheetOptions">
              <ng-container *ngIf="actionSheetOptions.length > 0">
                <ion-button class="add-edit-expense--header-btn-container__btn" (click)="showMoreActions()">
                  <ion-icon [src]="'../../../assets/svg/dot-menu.svg'"></ion-icon>
                </ion-button>
              </ng-container>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [ngClass]="{'d-none': isCameraPreviewStarted}">
  <ng-container *ngIf="fg">
    <form #formContainer [formGroup]="fg" class="add-edit-expense--form">
      <div>
        <div *ngIf="isIncompleteExpense" class="add-edit-expense--alert-offline">
          <app-fy-alert-info message="Please save the expense after reviewing it." type="warning"></app-fy-alert-info>
        </div>

        <div *ngIf="duplicateExpenses?.length > 0" class="add-edit-expense--alert-offline">
          <app-fy-alert-info
            [message]="'This expense might be a duplicate of an existing expense.'"
            [type]="'warning'"
            [showActionButton]="true"
            [actionButtonContent]="'View'"
            (actionClick)="showSuggestedDuplicates(duplicateExpenses)"
          >
          </app-fy-alert-info>
        </div>

        <div *ngIf="instaFyleCancelled" class="add-edit-expense--alert-offline">
          <app-fy-alert-info
            [message]="'Extracting receipt details is taking longer than expected due to a bad network, please add the details manually'"
            [type]="'information'"
          >
          </app-fy-alert-info>
        </div>

        <ng-container *ngIf="etxn$|async as etxn">
          <ng-container *ngIf="mode === 'edit' && etxn.tx.policy_flag">
            <ng-container *ngIf="policyDetails">
              <app-fy-policy-violation-info
                [policyDetails]="policyDetails"
                [criticalPolicyViolated]="isCriticalPolicyViolated$|async"
              ></app-fy-policy-violation-info>
            </ng-container>
          </ng-container>

          <div *ngIf="isSplitExpense" class="add-edit-expense--alert-split">
            <app-fy-alert-info [message]="'Expense created due to split.'" [type]="'information'"></app-fy-alert-info>
          </div>

          <ng-container *ngIf="isAmountCapped$|async">
            <div class="capped-info" *ngIf="!(isCriticalPolicyViolated$|async)">
              <mat-icon class="capped-icon" svgIcon="fy-info"></mat-icon>
              <div class="capped-message">
                Claimed amount {{etxn.tx.user_amount | currency: etxn.tx.currency: '' }} was capped to {{etxn.tx.amount
                | currency: etxn.tx.currency: '' }} due to policy
                <span *ngIf="isAmountDisabled$|async"> and cannot be edited.</span>
              </div>
            </div>
          </ng-container>
        </ng-container>

        <ng-container *ngIf="isCccExpense">
          <ng-container *ngIf="etxn$|async as etxn">
            <div
              class="add-edit-expense--split-info-container add-edit-expense--split-info-container__with-border"
              *ngIf="(!(etxn?.tx?.report_id) && !(reviewList?.length > 1)) && (isCorporateCreditCardEnabled && canRemoveCardExpense)"
            >
              <mat-icon class="add-edit-expense--split-info-icon" svgIcon="fy-info"></mat-icon>
              <div class="add-edit-expense--split-info-message">
                If the expense is merged with incorrect card details, click on Options (<span
                  ><ion-icon
                    class="add-edit-expense--icon-dots"
                    [src]="'../../../assets/svg/dot-menu.svg'"
                  ></ion-icon></span
                >) to remove the card details.
              </div>
            </div>
          </ng-container>
          <ion-grid class="add-edit-expense--card-container">
            <ion-row>
              <ion-col>
                <div class="add-edit-expense--card-container__label">Card number</div>
                <div class="add-edit-expense--card-container__value">
                  {{ cardNumber ? (cardNumber | maskNumber) : '-' }}
                </div>
              </ion-col>
              <ion-col>
                <div class="add-edit-expense--card-container__label">Spend Date</div>
                <div class="add-edit-expense--card-container__value">
                  {{ selectedCCCTransaction?.txn_dt | date: 'MMM dd, YYYY' }}
                </div>
              </ion-col>
              <ion-col>
                <div class="add-edit-expense--card-container__label">Spend Amount</div>
                <div *ngIf="selectedCCCTransaction?.amount > 0">
                  <span class="add-edit-expense--card-container__value"
                    >{{ selectedCCCTransaction?.amount | humanizeCurrency: selectedCCCTransaction?.currency }}</span
                  >
                  <span class="add-edit-expense--card-container__txn-type">DR</span>
                </div>
                <div *ngIf="selectedCCCTransaction?.amount < 0">
                  <span class="add-edit-expense--card-container__value add-edit-expense--card-container__credit"
                    >{{ selectedCCCTransaction?.amount * -1 | humanizeCurrency: selectedCCCTransaction?.currency
                    }}</span
                  >
                  <span class="add-edit-expense--card-container__txn-type add-edit-expense--card-container__credit"
                    >CR</span
                  >
                </div>
              </ion-col>
            </ion-row>
            <ng-container *ngIf="selectedCCCTransaction?.description">
              <ion-row>
                <ion-col>
                  <div class="add-edit-expense--card-container__label">Card Transaction</div>
                  <div class="add-edit-expense--card-container__value">{{ selectedCCCTransaction.description }}</div>
                </ion-col>
              </ion-row>
            </ng-container>
          </ion-grid>
        </ng-container>

        <div class="add-edit-expense--receipt-currency-container">
          <ng-container *ngIf="attachedReceiptsCount === 0">
            <div *ngIf="!reviewList?.length || canAttachReceipts" class="add-edit-expense--receipt">
              <div *ngIf="attachmentUploadInProgress" class="add-edit-expense--receipt-image">
                <ion-spinner class="add-edit-expense--spinner-icon" icon="circles"></ion-spinner>
                <div class="add-edit-expense--receipt-image-subheader">Uploading</div>
              </div>

              <div
                (click)="addAttachments($event)"
                *ngIf="(attachedReceiptsCount === 0 && !attachmentUploadInProgress)"
                class="add-edit-expense--receipt-image"
              >
                <input *ngIf="isIos" type="file" #fileUpload accept="application/pdf,image/*" class="d-none" />
                <img class="add-edit-expense--receipt-image-icon" src="../../../assets/images/add-to-list.png" />
              </div>

              <div
                (click)="viewAttachments()"
                *ngIf="attachedReceiptsCount > 0 && !attachmentUploadInProgress"
                class="add-edit-expense--receipt-image"
              >
                <mat-icon class="add-edit-expense--receipt-background" svgIcon="fy-attachment"></mat-icon>
                <div class="add-edit-expense--receipt-text add-edit-expense--receipt-text__count">
                  {{attachedReceiptsCount}}
                </div>
                <mat-icon
                  (click)="addAttachments($event)"
                  class="add-edit-expense--receipt-image-icon add-edit-expense--receipt-add-more-icon"
                >
                  add_circle
                </mat-icon>
                <input *ngIf="isIos" type="file" #fileUpload accept="application/pdf,image/*" class="d-none" />
              </div>
            </div>
          </ng-container>

          <div>
            <div *ngIf="etxn$|async as etxn" class="add-edit-expense--currency">
              <ng-container *ngIf="homeCurrency$|async as homeCurrency">
                <app-currency
                  [formControl]="fg?.controls?.currencyObj"
                  [homeCurrency]="homeCurrency"
                  [recentlyUsed]="recentCurrencies"
                  [txnDt]="fg?.controls?.dateOfSpend?.value"
                  [expanded]="attachedReceiptsCount === 0"
                  [touchedInParent]="fg?.controls?.currencyObj?.touched"
                  [validInParent]="fg?.controls?.currencyObj?.valid"
                >
                </app-currency>
                <div
                  *ngIf="fg.controls.currencyObj.touched && !fg.controls.currencyObj.valid"
                  class="add-edit-expense--amount-error"
                  [ngClass]="{'add-edit-expense--orig-amount-error': fg.controls?.currencyObj?.value?.orig_currency}"
                >
                  Please enter the amount.
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <app-receipt-preview-thumbnail
          *ngIf="newExpenseDataUrls && newExpenseDataUrls.length > 0"
          [attachments]="newExpenseDataUrls"
          (addMoreAttachments)="addAttachments($event)"
          (viewAttachments)="viewAttachments()"
          [canEdit]="true"
        >
          <input *ngIf="isIos" type="file" #fileUpload accept="application/pdf,image/*" class="d-none" />
        </app-receipt-preview-thumbnail>

        <ng-container *ngIf="attachments$|async as attachments">
          <app-receipt-preview-thumbnail
            *ngIf="attachments.length > 0"
            [attachments]="attachments"
            (addMoreAttachments)="addAttachments($event)"
            (viewAttachments)="viewAttachments()"
            [isUploading]="attachmentUploadInProgress"
            [canEdit]="true"
          >
            <input *ngIf="isIos" type="file" #fileUpload accept="application/pdf,image/*" class="d-none" />
          </app-receipt-preview-thumbnail>
        </ng-container>

        <div class="add-edit-expense--primary-block">
          <ion-grid class="ion-grid-no-padding">
            <ion-row>
              <ion-col [size]="showPaymentMode ? 6 : 12">
                <ng-container *ngIf="txnFields$|async as txnFields">
                  <div
                    *ngIf="txnFields?.txn_dt"
                    [ngClass]="{'add-edit-expense--internal-block__invalid add-edit-expense--date__invalid': fg.controls.dateOfSpend.touched && !fg.controls.dateOfSpend.valid}"
                    class="add-edit-expense--date add-edit-expense--internal-block add-edit-expense--internal-block__margin"
                  >
                    <div
                      [ngClass]="{'add-edit-expense--date-label__invalid': fg.controls.dateOfSpend.touched && !fg.controls.dateOfSpend.valid}"
                      class="add-edit-expense--date-label"
                    >
                      {{txnFields.txn_dt?.field_name || 'Date of Spend'}}
                      <span class="add-edit-expense--mandatory" *ngIf="txnFields.txn_dt?.is_mandatory">*</span>
                    </div>
                    <input
                      appFormatDate
                      (keydown)="$event.preventDefault()"
                      [max]="maxDate"
                      [min]="minDate"
                      [placeholder]="txnFields.txn_dt?.placeholder || 'Date of Spend'"
                      class="add-edit-expense--date-input date-input__format smartlook-show"
                      formControlName="dateOfSpend"
                      type="date"
                      [name]="txnFields.txn_dt?.field_name || 'Date of Spend'"
                    />
                  </div>
                  <div
                    *ngIf="fg.controls.dateOfSpend.touched && !fg.controls.dateOfSpend.valid"
                    class="add-edit-expense--date-error"
                  >
                    Please select a valid date.
                  </div>
                </ng-container>
              </ion-col>
              <ion-col size="6" *ngIf="showPaymentMode">
                <ng-container *ngIf="paymentModes$|async as paymentModes">
                  <div
                    [ngClass]="{'add-edit-expense--internal-block_special': fg.controls.paymentMode.value}"
                    class="add-edit-expense--payment-modes add-edit-expense--internal-block"
                  >
                    <app-fy-select
                      [disabled]="isExpenseBankTxn"
                      [enableSearch]="false"
                      [label]="'Payment Mode'"
                      [mandatory]="true"
                      [nullOption]="false"
                      [options]="paymentModes"
                      [selectModalHeader]="'Select Payment Mode'"
                      [selectionElement]="paymentMode"
                      formControlName="paymentMode"
                      [placeholder]="'Payment Mode'"
                      [touchedInParent]="fg.controls.paymentMode.touched"
                      [validInParent]="fg.controls.paymentMode.valid"
                    >
                    </app-fy-select>
                    <ng-template #paymentMode let-label="label" let-paymentMode="value" let-selected="selected">
                      <div>
                        <div class="add-edit-expense--payment-mode-header">{{label}}</div>
                        <ng-container *ngIf="paymentMode">
                          <ng-container *ngIf="paymentMode.acc.type === 'PERSONAL_ADVANCE_ACCOUNT'">
                            <div class="add-edit-expense--payment-mode-section">{{paymentMode.advance.purpose}}</div>
                          </ng-container>
                          <div *ngIf="paymentMode.acc.isReimbursable" class="add-edit-expense--payment-mode-section">
                            (Reimbursable)
                          </div>
                          <div *ngIf="!paymentMode.acc.isReimbursable" class="add-edit-expense--payment-mode-section">
                            (Non Reimbursable)
                          </div>
                        </ng-container>
                      </div>
                      <mat-icon *ngIf="selected" class="add-edit-expense--check"> check </mat-icon>
                    </ng-template>
                  </div>
                  <div
                    *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid"
                    class="add-edit-expense--error"
                  >
                    Please select a valid payment mode.
                  </div>
                </ng-container>
              </ion-col>
            </ion-row>
          </ion-grid>
          <ng-container *ngIf="isAdvancesEnabled$">
            <app-fy-alert-info
              *ngIf="(isBalanceAvailableInAnyAdvanceAccount$ | async) && !isCreatedFromCCC"
              [message]="'You have outstanding balance in your advance account(s)'"
              [type]="'information'"
            >
            </app-fy-alert-info>
          </ng-container>
        </div>

        <ng-container *ngIf="isCCCPaymentModeSelected$|async">
          <app-fy-alert-info
            *ngIf="!isCccExpense"
            [type]="'information'"
            [message]="'Fyle will automatically merge this expense with the corresponding corporate card transaction when it flows into fyle.'"
          ></app-fy-alert-info>
        </ng-container>

        <div class="add-edit-expense--primary-block">
          <app-fy-alert-info
            *ngIf="(isCCCAccountSelected$|async) && !selectedCCCTransaction && canChangeMatchingCCCTransaction && !(transactionInReport$|async)"
            [message]="'Expense will be saved as a draft. Kindly ensure that it is matched with an appropriate card transaction later, although we will attempt to auto-match it for you.'"
            [type]="'warning'"
          >
          </app-fy-alert-info>

          <ng-container *ngIf="txnFields$|async as txnFields">
            <div class="add-edit-expense--project-container" *ngIf="txnFields?.project_id">
              <ng-container *ngIf="isConnected$|async">
                <ng-container *ngIf="isProjectsEnabled$|async as isProjectsEnabled">
                  <ng-container *ngIf="isProjectsVisible$|async">
                    <div
                      class="add-edit-expense--internal-block add-edit-expense--project-block"
                      [ngClass]="{ 'add-edit-expense--no-project' : !fg.controls.project.value}"
                    >
                      <app-fy-select-project
                        [cacheName]="'expenseProjectCache'"
                        [defaultValue]="true"
                        [label]="txnFields?.project_id?.field_name"
                        [placeholder]="txnFields?.project_id?.placeholder"
                        [mandatory]="txnFields?.project_id?.is_mandatory"
                        [recentlyUsed]="recentProjects"
                        formControlName="project"
                        [validInParent]="fg.controls.project.valid"
                        [touchedInParent]="fg.controls.project.touched"
                      >
                      </app-fy-select-project>
                    </div>
                  </ng-container>
                </ng-container>
              </ng-container>

              <div *ngIf="isProjectsEnabled$|async">
                <div *ngIf="isProjectsVisible$|async">
                  <div *ngIf="fg.controls.project.value">
                    <mat-checkbox formControlName="billable">
                      <span class="add-edit-expense--checkbox"> Billable </span>
                    </mat-checkbox>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="isProjectsEnabled$|async">
              <div *ngIf="isProjectsVisible$|async">
                <div *ngIf="fg.controls.project.touched && !fg.controls.project.valid" class="add-edit-expense--error">
                  Please select a project.
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="txnFields$|async as txnFields">
            <ng-container *ngIf="dependentFields$|async as dependentFields">
              <ng-container *ngIf="etxn$|async as etxn">
                <ng-container *ngIf="selectedProject$|async as selectedProject">
                  <ng-container formArrayName="project_dependent_fields">
                    <app-dependent-fields
                      #projectDependentFieldsRef
                      [dependentFieldsFormArray]="fg.controls.project_dependent_fields"
                      [dependentCustomFields]="dependentFields"
                      [parentFieldId]="txnFields?.project_id?.id"
                      [parentFieldValue]="selectedProject?.projectv2_name"
                      [txnCustomProperties]="etxn.tx.custom_properties || []"
                    ></app-dependent-fields>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>

          <ng-container *ngIf="txnFields$|async as txnFields">
            <ng-container *ngIf="!((isProjectsEnabled$|async) && !(isConnected$|async))">
              <ng-container *ngIf="filteredCategories$|async as categories">
                <ng-container *ngIf="categories.length">
                  <div
                    *ngIf="txnFields?.org_category_id"
                    [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.category.touched && !fg.controls.category.valid}"
                    class="add-edit-expense--internal-block"
                  >
                    <app-virtual-select
                      [cacheName]="'recentCategoryList'"
                      [defaultLabelProp]="'displayName'"
                      [label]="'Category'"
                      [mandatory]="txnFields?.org_category_id?.is_mandatory"
                      [options]="categories"
                      [selectModalHeader]="'Select Category'"
                      [recentlyUsed]="recentCategories"
                      formControlName="category"
                      [placeholder]="txnFields.org_category_id.placeholder"
                    >
                    </app-virtual-select>
                  </div>
                  <div
                    *ngIf="fg.controls.category.touched && !fg.controls.category.valid"
                    class="add-edit-expense--error"
                  >
                    Please select a category.
                  </div>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>

          <ng-container *ngIf="taxSettings$|async as taxSettings">
            <ng-container *ngIf="txnFields$|async as txnFields">
              <ng-container *ngIf="taxGroupsOptions$|async as taxGroups">
                <div *ngIf="txnFields?.tax_group_id && taxGroups?.length > 0" class="add-edit-expense--primary-block">
                  <div
                    class="add-edit-expense--internal-block"
                    [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.tax_group.touched && !fg.controls.tax_group.valid}"
                  >
                    <app-fy-select
                      [label]="(txnFields.tax_group_id.field_name || 'Tax Group')"
                      [options]="taxGroups"
                      [mandatory]="txnFields.tax_group_id.is_mandatory"
                      [selectModalHeader]="'Select ' + (txnFields.tax_group_id.field_name || 'Tax Group')"
                      formControlName="tax_group"
                      [placeholder]="txnFields.tax_group_id.placeholder"
                      [touchedInParent]="fg.controls.tax_group.touched"
                      [validInParent]="fg.controls.tax_group.valid"
                    >
                    </app-fy-select>
                  </div>
                  <div
                    *ngIf="fg.controls.tax_group.touched && !fg.controls.tax_group.valid"
                    class="add-edit-expense--error"
                  >
                    Please select a valid tax group.
                  </div>
                  <div class="add-edit-expense--text add-edit-expense--internal-block">
                    <div class="add-edit-expense--text-label">
                      {{(taxSettings.name || 'Tax Amount') | ellipsis: 30 }}
                    </div>
                    <app-fy-number formControlName="tax_amount" [placeholder]="'Enter Tax Amount'"></app-fy-number>
                  </div>
                  <div
                    *ngIf="fg.controls.tax_amount.touched && !fg.controls.tax_amount.valid"
                    class="add-edit-expense--error"
                  >
                    Please enter a valid tax amount.
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </ng-container>

          <ng-container *ngIf="txnFields$|async as txnFields">
            <ng-container *ngIf="isConnected$|async as isConnected">
              <div>
                <ion-grid class="ion-grid-no-padding">
                  <ion-row>
                    <ion-col
                      *ngIf="txnFields.location1?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                    >
                      <div
                        class="add-edit-expense--internal-block"
                        [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.location_1.touched && !fg.controls.location_1.valid, 'add-edit-expense--internal-block__margin': txnFields.location2?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)}"
                      >
                        <app-fy-location
                          [label]="txnFields.location1?.field_name"
                          [mandatory]="txnFields.location1?.is_mandatory"
                          formControlName="location_1"
                          [placeholder]="txnFields.location1?.placeholder"
                          [touchedInParent]="fg.controls.location_1.touched"
                          [validInParent]="fg.controls.location_1.valid"
                        >
                        </app-fy-location>
                      </div>
                      <div
                        *ngIf="fg.controls.location_1.touched && !fg.controls.location_1.valid"
                        class="add-edit-expense--error"
                      >
                        Please select a valid city.
                      </div>
                    </ion-col>
                    <ion-col
                      *ngIf="txnFields.location2?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                    >
                      <div
                        class="add-edit-expense--internal-block"
                        [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.location_2.touched && !fg.controls.location_2.valid}"
                      >
                        <app-fy-location
                          [label]="txnFields.location2?.field_name"
                          [mandatory]="txnFields.location2?.is_mandatory"
                          formControlName="location_2"
                          [placeholder]="txnFields.location2?.placeholder"
                          [touchedInParent]="fg.controls.location_2.touched"
                          [validInParent]="fg.controls.location_2.valid"
                        >
                        </app-fy-location>
                      </div>
                      <div
                        *ngIf="fg.controls.location_2.touched && !fg.controls.location_2.valid"
                        class="add-edit-expense--error"
                      >
                        Please select a valid city.
                      </div>
                    </ion-col>
                  </ion-row>
                </ion-grid>

                <ion-grid class="ion-grid-no-padding">
                  <ion-row>
                    <ion-col
                      *ngIf="txnFields.from_dt?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                    >
                      <div
                        [ngClass]="{'add-edit-expense--internal-block__invalid add-edit-expense--date__invalid': fg.controls.from_dt.touched && !fg.controls.from_dt.valid, 'add-edit-expense--internal-block__margin': txnFields.to_dt?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)}"
                        class="add-edit-expense--date add-edit-expense--internal-block"
                      >
                        <div
                          [ngClass]="{'add-edit-expense--date-label__invalid': fg.controls.from_dt.touched && !fg.controls.from_dt.valid}"
                          class="add-edit-expense--date-label add-edit-expense--date-label__large"
                        >
                          {{txnFields.from_dt?.field_name}}
                          <span class="add-edit-expense--mandatory">*</span>
                        </div>
                        <input
                          appFormatDate
                          class="add-edit-expense--date-input date-input__format smartlook-show"
                          formControlName="from_dt"
                          [name]="txnFields.from_dt?.field_name"
                          type="date"
                          [placeholder]="txnFields.from_dt?.placeholder || 'Select '+ txnFields.from_dt?.field_name"
                        />
                      </div>
                      <div
                        *ngIf="fg.controls.from_dt.touched && !fg.controls.from_dt.valid"
                        class="add-edit-expense--date-error"
                      >
                        Please select a valid {{txnFields.from_dt?.field_name}}.
                      </div>
                    </ion-col>
                    <ion-col
                      *ngIf="txnFields.to_dt?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                    >
                      <div
                        [ngClass]="{'add-edit-expense--internal-block__invalid add-edit-expense--date__invalid': fg.controls.to_dt.touched && !fg.controls.to_dt.valid}"
                        class="add-edit-expense--date add-edit-expense--internal-block"
                      >
                        <div
                          [ngClass]="{'add-edit-expense--date-label__invalid': fg.controls.to_dt.touched && !fg.controls.to_dt.valid}"
                          class="add-edit-expense--date-label add-edit-expense--date-label__large"
                        >
                          {{txnFields.to_dt?.field_name}}
                          <span class="add-edit-expense--mandatory">*</span>
                        </div>
                        <input
                          appFormatDate
                          class="add-edit-expense--date-input date-input__format smartlook-show"
                          formControlName="to_dt"
                          [name]="txnFields.to_dt?.field_name"
                          type="date"
                          [placeholder]="txnFields.from_dt?.placeholder || 'Select '+ txnFields.to_dt?.field_name"
                        />
                      </div>
                      <div
                        *ngIf="fg.controls.to_dt.touched && !fg.controls.to_dt.valid"
                        class="add-edit-expense--date-error"
                      >
                        Please select a valid {{txnFields.to_dt?.field_name}}.
                      </div>
                    </ion-col>
                  </ion-row>
                </ion-grid>

                <ion-grid class="ion-grid-no-padding">
                  <ion-row>
                    <ion-col
                      *ngIf="txnFields.flight_journey_travel_class?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                    >
                      <div
                        class="add-edit-expense--internal-block"
                        [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.flight_journey_travel_class.touched && !fg.controls.flight_journey_travel_class.valid, 'add-edit-expense--internal-block__margin': txnFields.flight_return_travel_class?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)}"
                      >
                        <app-fy-select
                          *ngIf="flightJourneyTravelClassOptions$|async as flightJourneyTravelClassOptions"
                          [label]="txnFields.flight_journey_travel_class?.field_name"
                          [mandatory]="txnFields.flight_journey_travel_class?.is_mandatory"
                          [options]="txnFields.flight_journey_travel_class?.options"
                          [selectModalHeader]="'Select Travel Class'"
                          formControlName="flight_journey_travel_class"
                          [placeholder]="txnFields.flight_journey_travel_class?.placeholder"
                          [touchedInParent]="fg.controls.flight_journey_travel_class.touched"
                          [validInParent]="fg.controls.flight_journey_travel_class.valid"
                        >
                        </app-fy-select>
                      </div>
                      <div
                        *ngIf="fg.controls.flight_journey_travel_class.touched && !fg.controls.flight_journey_travel_class.valid"
                        class="add-edit-expense--error"
                      >
                        Please select a valid class for {{ txnFields.flight_journey_travel_class?.field_name }}.
                      </div>
                    </ion-col>
                    <ion-col
                      *ngIf="txnFields.flight_return_travel_class?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                    >
                      <div
                        class="add-edit-expense--internal-block"
                        [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.flight_return_travel_class.touched && !fg.controls.flight_return_travel_class.valid}"
                      >
                        <app-fy-select
                          *ngIf="flightJourneyTravelClassOptions$|async as flightJourneyTravelClassOptions"
                          [label]="txnFields.flight_return_travel_class?.field_name"
                          [mandatory]="txnFields.flight_return_travel_class?.is_mandatory"
                          [options]="txnFields.flight_journey_travel_class?.options"
                          [selectModalHeader]="'Select Travel Class'"
                          formControlName="flight_return_travel_class"
                          name="flightReturnClass"
                          [placeholder]="txnFields.flight_return_travel_class?.placeholder"
                          [touchedInParent]="fg.controls.flight_return_travel_class.touched"
                          [validInParent]="fg.controls.flight_return_travel_class.valid"
                        >
                        </app-fy-select>
                      </div>
                      <div
                        *ngIf="fg.controls.flight_return_travel_class.touched && !fg.controls.flight_return_travel_class.valid"
                        class="add-edit-expense--error"
                      >
                        Please select a valid class for {{ txnFields.flight_return_travel_class?.field_name }}.
                      </div>
                    </ion-col>
                  </ion-row>
                </ion-grid>

                <div
                  *ngIf="txnFields.train_travel_class?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                  [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.train_travel_class.touched && !fg.controls.train_travel_class.valid, 'add-edit-expense--text__invalid': fg.controls.train_travel_class.touched && !fg.controls.train_travel_class.valid && txnFields.train_travel_class?.type === 'TEXT', 'add-edit-expense--text': txnFields.train_travel_class?.type === 'TEXT'}"
                  class="add-edit-expense--internal-block"
                >
                  <span *ngIf="txnFields.train_travel_class?.type === 'TEXT'">
                    <div
                      [ngClass]="{'add-edit-expense--text-label__invalid': fg.controls.train_travel_class.touched && !fg.controls.train_travel_class.valid}"
                      class="add-edit-expense--text-label add-edit-expense--text-label__large"
                    >
                      {{txnFields.train_travel_class?.field_name}}
                      <span class="add-edit-expense--mandatory">*</span>
                    </div>
                    <input
                      (blur)="focusState = false"
                      (focus)="focusState = true"
                      [placeholder]="txnFields.train_travel_class.placeholder || 'Enter ' + txnFields.train_travel_class.field_name"
                      class="add-edit-expense--text-input add-edit-expense--text-input__large smartlook-show"
                      formControlName="train_travel_class"
                      type="text"
                    />
                  </span>

                  <app-fy-select
                    *ngIf="txnFields.train_travel_class?.type === 'SELECT'"
                    [label]="txnFields.train_travel_class?.field_name"
                    [mandatory]="txnFields.train_travel_class?.is_mandatory"
                    [options]="txnFields.train_travel_class?.options"
                    formControlName="train_travel_class"
                    [placeholder]="txnFields.train_travel_class?.placeholder"
                    [touchedInParent]="fg.controls.train_travel_class.touched"
                    [validInParent]="fg.controls.train_travel_class.valid"
                  >
                  </app-fy-select>
                </div>
                <div
                  *ngIf="fg.controls.train_travel_class.touched && !fg.controls.train_travel_class.valid"
                  [ngClass]="{'add-edit-expense--travel-text-error': txnFields.train_travel_class?.type === 'TEXT', 'add-edit-expense--travel-select-error': txnFields.train_travel_class?.type === 'SELECT'}"
                >
                  Please select valid {{ txnFields.train_travel_class?.field_name }}.
                </div>

                <div
                  *ngIf="txnFields.bus_travel_class?.is_mandatory && systemCategories?.includes(fg.value.category?.fyle_category)"
                  [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.bus_travel_class.touched && !fg.controls.bus_travel_class.valid, 'add-edit-expense--text__invalid': fg.controls.bus_travel_class.touched && !fg.controls.bus_travel_class.valid && txnFields.bus_travel_class?.type === 'TEXT', 'add-edit-expense--text': txnFields.bus_travel_class?.type === 'TEXT'}"
                  class="add-edit-expense--internal-block"
                >
                  <div
                    *ngIf="txnFields.bus_travel_class?.type === 'TEXT'"
                    [ngClass]="{'add-edit-expense--text-label__invalid': fg.controls.bus_travel_class.touched && !fg.controls.bus_travel_class.valid}"
                    class="add-edit-expense--text-label add-edit-expense--text-label__large"
                  >
                    {{txnFields.bus_travel_class?.field_name}}
                    <div class="add-edit-expense--mandatory" *ngIf="txnFields.bus_travel_class?.is_mandatory">*</div>
                  </div>
                  <input
                    (blur)="focusState = false"
                    (focus)="focusState = true"
                    [placeholder]="txnFields.bus_travel_class?.placeholder || 'Enter ' + txnFields.bus_travel_class?.field_name"
                    *ngIf="txnFields.bus_travel_class?.type === 'TEXT'"
                    class="add-edit-expense--text-input add-edit-expense--text-input__large smartlook-show"
                    formControlName="bus_travel_class"
                    type="text"
                  />
                  <app-fy-select
                    *ngIf="txnFields.bus_travel_class?.type === 'SELECT'"
                    [label]="txnFields.bus_travel_class?.field_name"
                    [mandatory]="txnFields.bus_travel_class?.is_mandatory"
                    [options]="txnFields.bus_travel_class?.options"
                    [selectModalHeader]="'Select Travel Class'"
                    formControlName="bus_travel_class"
                    hide-none="true"
                    [placeholder]="txnFields.bus_travel_class?.placeholder"
                    [touchedInParent]="fg.controls.bus_travel_class.touched"
                    [validInParent]="fg.controls.bus_travel_class.valid"
                  >
                  </app-fy-select>
                </div>
                <div
                  *ngIf="fg.controls.bus_travel_class.touched && !fg.controls.bus_travel_class.valid"
                  [ngClass]="{'add-edit-expense--travel-text-error': txnFields.bus_travel_class?.type === 'TEXT', 'add-edit-expense--travel-select-error': txnFields.bus_travel_class?.type === 'SELECT'}"
                >
                  Please select valid {{ txnFields.bus_travel_class?.field_name }}.
                </div>

                <div
                  *ngIf="breakfastSystemCategories?.includes(fg?.value?.category?.fyle_category) && isExpandedView"
                  class="add-edit-expense--internal-block"
                >
                  <mat-checkbox formControlName="hotel_is_breakfast_provided">
                    <span class="add-edit-expense--text-label"> Breakfast Provided </span>
                  </mat-checkbox>
                </div>

                <ng-container *ngIf="txnFields.distance?.is_mandatory && fg.value?.category?.fyle_category === 'Taxi'">
                  <div
                    [ngClass]="{'add-edit-expense--internal-block__invalid add-edit-expense--text__invalid': fg.controls.distance.touched && !fg.controls.distance.valid}"
                    class="add-edit-expense--internal-block add-edit-expense--text"
                  >
                    <div
                      [ngClass]="{'add-edit-expense--text-label__invalid': fg.controls.distance.touched && !fg.controls.distance.valid}"
                      class="add-edit-expense--text-label"
                    >
                      {{txnFields.distance?.field_name}}
                      <span class="add-edit-expense--mandatory">*</span>
                    </div>
                    <app-fy-number
                      formControlName="distance"
                      [placeholder]="txnFields.distance?.placeholder || 'Enter ' + txnFields.distance?.field_name"
                    ></app-fy-number>
                  </div>
                  <div
                    *ngIf="fg.controls.distance.touched && !fg.controls.distance.valid"
                    class="add-edit-expense--distance-error"
                  >
                    Please enter {{ txnFields.distance?.field_name }}.
                  </div>

                  <div
                    class="add-edit-expense--internal-block"
                    [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.distance_unit.touched && !fg.controls.distance_unit.valid}"
                  >
                    <app-fy-select
                      [label]="txnFields.distance_unit?.field_name"
                      [mandatory]="txnFields.distance_unit?.is_mandatory"
                      [options]="txnFields.distance_unit?.options"
                      formControlName="distance_unit"
                      name="taxiDistanceUnit"
                      sub-title="Units"
                      title="Select Unit"
                      [placeholder]="txnFields.distance_unit?.placeholder"
                      [touchedInParent]="fg.controls.distance_unit.touched"
                      [validInParent]="fg.controls.distance_unit.valid"
                    >
                    </app-fy-select>
                  </div>
                  <div
                    *ngIf="fg.controls.distance_unit.touched && !fg.controls.distance_unit.valid"
                    class="add-edit-expense--distance-unit-error"
                  >
                    Please select {{ txnFields.distance_unit?.field_name }}.
                  </div>
                </ng-container>
              </div>
            </ng-container>
          </ng-container>

          <ng-container *ngIf="txnFields$|async as txnFields">
            <div
              *ngIf="txnFields?.vendor_id"
              [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.vendor_id.touched && !fg.controls.vendor_id.valid}"
              class="add-edit-expense--internal-block"
            >
              <app-fy-select-vendor
                *ngIf="!txnFields.vendor_id?.options?.length"
                [label]="txnFields.vendor_id?.field_name"
                [mandatory]="txnFields?.vendor_id?.is_mandatory"
                formControlName="vendor_id"
                [placeholder]="txnFields.vendor_id?.placeholder"
                [touchedInParent]="fg.controls.vendor_id.touched"
                [validInParent]="fg.controls.vendor_id.valid"
              >
              </app-fy-select-vendor>
              <app-virtual-select
                *ngIf="txnFields.vendor_id?.options?.length"
                [label]="txnFields.vendor_id?.field_name"
                [mandatory]="txnFields.vendor_id?.is_mandatory"
                [options]="txnFields.vendor_id?.options"
                [nullOption]="!txnFields.vendor_id?.is_mandatory"
                formControlName="vendor_id"
                [placeholder]="txnFields.vendor_id?.placeholder"
              >
              </app-virtual-select>
            </div>
            <div *ngIf="fg.controls.vendor_id.touched && !fg.controls.vendor_id.valid" class="add-edit-expense--error">
              Please select a merchant
            </div>
          </ng-container>
          <ng-container *ngIf="costCenters$|async as costCenters">
            <ng-container *ngIf="txnFields$|async as txnFields">
              <ng-container *ngIf="txnFields.cost_center_id?.is_mandatory || isExpandedView">
                <div *ngIf="costCenters.length > 0" class="add-edit-expense--primary-block">
                  <div
                    *ngIf="costCenters.length > 0 && txnFields?.cost_center_id"
                    class="add-edit-expense--internal-block"
                  >
                    <app-virtual-select
                      [cacheName]="'recentCostCenterList'"
                      [label]="txnFields.cost_center_id?.field_name"
                      [mandatory]="txnFields.cost_center_id?.is_mandatory"
                      [options]="costCenters"
                      [selectModalHeader]="'Select Cost Center'"
                      [recentlyUsed]="recentCostCenters"
                      formControlName="costCenter"
                      [placeholder]="txnFields.cost_center_id?.placeholder"
                    >
                    </app-virtual-select>
                  </div>
                  <div
                    *ngIf="fg.controls.costCenter.touched && !fg.controls.costCenter.valid"
                    class="add-edit-expense--error"
                  >
                    Please select {{ txnFields.cost_center_id?.field_name }}
                  </div>
                </div>

                <ng-container *ngIf="dependentFields$|async as dependentFields">
                  <ng-container *ngIf="etxn$|async as etxn">
                    <ng-container *ngIf="selectedCostCenter$|async as selectedCostCenter">
                      <ng-container formArrayName="cost_center_dependent_fields">
                        <app-dependent-fields
                          #costCenterDependentFieldsRef
                          [dependentFieldsFormArray]="fg.controls.cost_center_dependent_fields"
                          [dependentCustomFields]="dependentFields"
                          [parentFieldId]="txnFields?.cost_center_id?.id"
                          [parentFieldValue]="selectedCostCenter?.name"
                          [txnCustomProperties]="etxn.tx.custom_properties || []"
                        ></app-dependent-fields>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>

          <ng-container *ngIf="txnFields$|async as txnFields">
            <ng-container *ngIf="txnFields.purpose?.is_mandatory || isExpandedView">
              <ng-container *ngIf="txnFields?.purpose">
                <div
                  *ngIf="txnFields.purpose?.type === 'TEXT'"
                  class="add-edit-expense--text add-edit-expense--text-block"
                  [ngClass]="{'add-edit-expense--text__invalid': fg.controls.purpose.touched && !fg.controls.purpose.valid}"
                >
                  <div class="add-edit-expense--text-label">
                    {{ txnFields.purpose?.field_name | slice: 0:30 }}
                    <span class="add-edit-expense--mandatory" *ngIf="txnFields.purpose?.is_mandatory"> * </span>
                  </div>
                  <input
                    [placeholder]="txnFields.purpose?.placeholder || 'Enter '+txnFields.purpose?.field_name | slice: 0:30"
                    [required]="txnFields.purpose?.is_mandatory"
                    [title]="'Enter'+txnFields.purpose?.field_name"
                    class="add-edit-expense--text-input smartlook-show"
                    formControlName="purpose"
                  />
                </div>
                <div
                  *ngIf="txnFields.purpose?.type === 'SELECT'"
                  class="add-edit-expense--internal-block"
                  [ngClass]="{'add-edit-expense--internal-block__invalid': fg.controls.purpose.touched && !fg.controls.purpose.valid}"
                >
                  <app-fy-select
                    [cacheName]="'recentPurposeList'"
                    [label]="txnFields.purpose?.field_name"
                    [mandatory]="txnFields.purpose?.is_mandatory"
                    [nullOption]="txnFields.purpose?.is_mandatory ? false : true"
                    [options]="txnFields.purpose?.options"
                    [selectModalHeader]="'Enter '+ txnFields.purpose?.field_name"
                    formControlName="purpose"
                    [placeholder]="txnFields.purpose?.placeholder"
                    [touchedInParent]="fg.controls.purpose.touched"
                    [validInParent]="fg.controls.purpose.valid"
                  >
                  </app-fy-select>
                </div>
                <div *ngIf="fg.controls.purpose.touched && !fg.controls.purpose.valid" class="add-edit-expense--error">
                  Please enter {{ txnFields.purpose?.field_name }}.
                </div>
              </ng-container>
            </ng-container>
          </ng-container>
        </div>
      </div>

      <ng-container *ngIf="isConnected$|async as isConnected">
        <div class="add-edit-expense--primary-block">
          <ng-container *ngFor="let customInput of this.customInputs$ | async as customInputs">
            <ng-container *ngIf="customInput.mandatory || isExpandedView">
              <div
                [ngClass]="{'add-edit-expense--internal-block__invalid': customInput.control.controls.value.touched && !customInput.control.controls.value.valid}"
                class="add-edit-expense--internal-block"
              >
                <form [formGroup]="customInput.control">
                  <div
                    *ngIf="customInput.type !== 'BOOLEAN' && customInput.type !== 'SELECT'&&customInput.type !== 'MULTI_SELECT' && customInput.type !== 'USER_LIST' && customInput.type !== 'LOCATION'"
                    class="add-edit-expense--text"
                    [ngClass]="{'add-edit-expense--text__invalid': customInput.control.controls.value.touched && !customInput.control.controls.value.valid}"
                  >
                    <div
                      [ngClass]="{'add-edit-expense--text-label__invalid': customInput.control.controls.value.touched && !customInput.control.controls.value.valid}"
                      class="add-edit-expense--text-label"
                    >
                      {{customInput.name | ellipsis: 30}}
                      <span class="add-edit-expense--mandatory" *ngIf="customInput.mandatory"> * </span>
                    </div>
                    <input
                      (blur)="focusState = false"
                      (focus)="focusState = true"
                      *ngIf="customInput.type === 'TEXT'"
                      [placeholder]="customInput.placeholder || 'Enter ' + customInput.name | ellipsis: 30"
                      class="add-edit-expense--text-input smartlook-show"
                      formControlName="value"
                      type="text"
                    />

                    <app-fy-number
                      formControlName="value"
                      *ngIf="customInput.type === 'NUMBER'"
                      [placeholder]="customInput.placeholder || 'Enter ' + customInput.name | ellipsis: 30"
                    >
                    </app-fy-number>

                    <input
                      appFormatDate
                      *ngIf="customInput.type === 'DATE'"
                      class="add-edit-expense--date-input date-input__format smartlook-show"
                      formControlName="value"
                      type="date"
                      [name]="customInput.placeholder || customInput.name"
                    />
                  </div>

                  <div *ngIf="customInput.type === 'BOOLEAN'" class="add-edit-expense--checkbox">
                    <label>
                      <mat-checkbox formControlName="value"> {{customInput.name | ellipsis: 35 }} </mat-checkbox>
                    </label>
                  </div>

                  <div *ngIf="customInput.type === 'LOCATION'">
                    <app-fy-location
                      [label]="customInput.name  | ellipsis: 30"
                      [mandatory]="customInput.mandatory"
                      formControlName="value"
                      [placeholder]="customInput.placeholder | ellipsis: 30"
                      [touchedInParent]="customInput.control.controls.value.touched"
                      [validInParent]="customInput.control.controls.value.valid"
                    >
                    </app-fy-location>
                  </div>

                  <div *ngIf="customInput.type === 'SELECT'">
                    <app-fy-select
                      [label]="customInput.name  | ellipsis: 30"
                      [mandatory]="customInput.mandatory"
                      [options]="customInput.options"
                      [selectModalHeader]="'Select '+customInput.name"
                      [label]="customInput.name"
                      formControlName="value"
                      [placeholder]="customInput.placeholder | ellipsis: 30"
                      [touchedInParent]="customInput.control.controls.value.touched"
                      [validInParent]="customInput.control.controls.value.valid"
                    >
                    </app-fy-select>
                  </div>

                  <div *ngIf="customInput.type === 'MULTI_SELECT'">
                    <app-fy-multiselect
                      [label]="customInput.name  | ellipsis: 30"
                      [mandatory]="customInput.mandatory"
                      [options]="customInput.options"
                      [selectModalHeader]="'Select '+customInput.name"
                      [subheader]="customInput.name"
                      formControlName="value"
                      [placeholder]="customInput.placeholder | ellipsis: 30"
                      [touchedInParent]="customInput.control.controls.value.touched"
                      [validInParent]="customInput.control.controls.value.valid"
                    >
                    </app-fy-multiselect>
                  </div>

                  <div *ngIf="customInput.type === 'USER_LIST'">
                    <app-fy-userlist
                      [label]="customInput.name | ellipsis: 30"
                      [mandatory]="customInput.mandatory"
                      [allowCustomValues]="true"
                      formControlName="value"
                      [placeholder]="customInput.placeholder | ellipsis: 30"
                      [touchedInParent]="customInput.control.controls.value.touched"
                      [validInParent]="customInput.control.controls.value.valid"
                    >
                    </app-fy-userlist>
                  </div>
                </form>
              </div>
              <div
                *ngIf="customInput.control.controls.value.touched && !customInput.control.controls.value.valid"
                class="add-edit-expense--error"
              >
                Please enter {{ customInput.name }}.
              </div>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>

      <!-- Hide in offline/ critical policy violation/ draft expense/ only expense in the report(canAddToReport)-->
      <ng-container *ngIf="isConnected$|async as isConnected">
        <ng-container *ngIf="etxn$|async as etxn">
          <ng-container *ngIf="!(isCriticalPolicyViolated$|async)">
            <ng-container *ngIf="canRemoveFromReport || !etxn?.tx?.report_id">
              <ng-container *ngIf="reports$|async as reports">
                <div class="add-edit-expense--internal-block">
                  <app-fy-add-to-report
                    [label]="etxn.tx.report_id ? 'Report' : 'Add to Report'"
                    [autoSubmissionReportName]="autoSubmissionReportName$|async"
                    [options]="reports"
                    [isNewReportsFlowEnabled]="isNewReportsFlowEnabled"
                    formControlName="report"
                  ></app-fy-add-to-report>
                </div>
              </ng-container>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>

      <div *ngIf="mode === 'add'">
        <ng-container *ngIf="isExpandedView;else expandViewContent">
          <div class="expansion-btn" fill="clear" (click)="hideFields()">
            Hide more fields
            <ion-icon class="expansion-icon" name="chevron-up"></ion-icon>
          </div>
        </ng-container>
        <ng-template #expandViewContent>
          <div class="expansion-btn" fill="clear" (click)="showFields()">
            Show more fields
            <ion-icon class="expansion-icon" name="chevron-down"></ion-icon>
          </div>
        </ng-template>
      </div>

      <app-fy-alert-info
        *ngIf="isNotReimbursable$|async"
        [message]="'This expense will not be reimbursed as it has already been paid by your company.'"
        [type]="'information'"
      >
      </app-fy-alert-info>

      <ng-container *ngIf="isConnected$">
        <ng-container *ngIf="txnFields$|async as txnFields">
          <ng-container *ngIf="isProjectsEnabled$|async as isProjectsEnabled">
            <ng-container *ngIf="isIndividualProjectsEnabled$|async as isIndividualProjectsEnabled">
              <ng-container *ngIf="individualProjectIds$|async as individualProjectIds">
                <app-fy-alert-info
                  *ngIf="txnFields?.project_id?.is_mandatory && individualProjectIds.length === 0"
                  [message]="'There are no ' + txnFields?.project_id?.field_name + 's assigned to you, so this expense will be saved as a draft. Please contact admin for further help.'"
                  [type]="'warning'"
                >
                </app-fy-alert-info>
              </ng-container>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="isConnected$">
        <ng-container *ngIf="txnFields$|async as txnFields">
          <ng-container *ngIf="isCostCentersEnabled$|async as isCostCentersEnabled">
            <ng-container *ngIf="costCenters$|async as allowedCostCenters">
              <app-fy-alert-info
                class="add-edit-expense--cost-center-alert"
                *ngIf="txnFields?.cost_center_id?.is_mandatory && allowedCostCenters.length === 0"
                [message]="'There are no cost centers assigned to you, so this expense will be saved as a draft. Please contact admin for further help.'"
                [type]="'warning'"
              >
              </app-fy-alert-info>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>

      <!-- <div>
      <div *ngIf="canChangeMatchingCCCTransaction">
        Corporate card transaction cannot be unmatched since the report is already submitted.
      </div>
    </div>
    <div>
      <div>
        Card transaction cannot be unmatched as one of the associated split expenses is already submitted in a report.
      </div>
    </div>
     -->
    </form>
  </ng-container>
</ion-content>

<ng-container *ngIf="fg">
  <app-review-footer
    *ngIf="reviewList?.length"
    [activeIndex]="+activeIndex"
    [reviewList]="reviewList"
    [saveAndPrevLoader]="saveAndPrevExpenseLoader"
    [saveAndNextLoader]="saveAndNextExpenseLoader"
    (saveAndGoToPrev)="saveExpenseAndGotoPrev()"
    (saveAndGoToNext)="saveExpenseAndGotoNext()"
  ></app-review-footer>
  <ion-footer
    [ngClass]="{'d-none': isCameraPreviewStarted}"
    class="add-edit-expense--footer-container"
    *ngIf="!reviewList?.length"
  >
    <ion-toolbar
      class="add-edit-expense--footer-box"
      mode="md"
      [ngClass]="{'add-edit-expense--footer-toolbar__offline': !(isConnected$|async)}"
    >
      <div class="add-edit-expense--footer-toolbar">
        <ion-buttons *ngIf="!reviewList">
          <ion-button
            (click)="saveAndNewExpense()"
            *ngIf="mode === 'add' && !navigateBack"
            [disabled]="saveExpenseLoader || saveAndNewExpenseLoader"
            [loadingText]="'Saving'"
            [loading]="saveAndNewExpenseLoader"
            appFormButtonValidation
            class="btn-secondary"
          >
            Save and new
          </ion-button>
          <ion-button
            (click)="closeAddEditExpenses()"
            *ngIf="mode === 'edit' && !navigateBack"
            [disabled]="saveExpenseLoader"
            class="btn-secondary"
          >
            Cancel
          </ion-button>
          <ion-button
            (click)="saveExpense()"
            [disabled]="saveExpenseLoader || saveAndNewExpenseLoader"
            [loadingText]="'Saving'"
            [loading]="saveExpenseLoader"
            appFormButtonValidation
            class="btn-primary"
          >
            Save Expense
          </ion-button>
        </ion-buttons>
      </div>
    </ion-toolbar>
  </ion-footer>
</ng-container>
